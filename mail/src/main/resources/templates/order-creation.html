<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Создание заказа</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<button id="createNewOrderBtn">Создать заказ</button>

<div id="orderFormContainer" style="display:none;">
    <h1>Создание заказа</h1>

    <form id="orderForm">
        <div>
            <label>Email:</label>
            <input type="email" id="userEmail" required>
        </div>

        <div>
            <h2>Добавление услуги</h2>
            <select id="serviceSelect">
                <option th:each="service : ${services}"
                        th:value="${service.id}"
                        th:text="${service.name}"
                        th:data-code="${service.code}">
                </option>
            </select>
            <button type="button" id="addServiceBtn">Добавить в корзину</button>
        </div>

        <th:block th:each="service : ${services}">
            <div th:replace="${service.code == 'credit_card'} ? ~{service-params/credit-card-params} : ~{}"></div>
            <div th:replace="${service.code == 'transfer_funds'} ? ~{service-params/transfer-funds-params} : ~{}"></div>
            <div th:replace="${service.code == 'mortgage'} ? ~{service-params/mortgage-params} : ~{}"></div>
        </th:block>

        <h2>Корзина услуг</h2>
        <table id="cartTable">
            <thead>
            <tr>
                <th>Услуга</th>
                <th>Действия</th>
            </tr>
            </thead>
            <tbody id="cartBody">
            </tbody>
        </table>

        <button type="button" id="saveOrderBtn">Сохранить заказ</button>
    </form>
</div>

<script>
    $(document).ready(function() {
        $('#createNewOrderBtn').click(function() {
            $('#orderFormContainer').show();
            $(this).hide();
        });

        const cart = [];

        $('#serviceSelect').change(function() {
            $('#creditCardDetailsContainer, #transferFundsDetailsContainer, #mortgageDetailsContainer').hide();

            const selectedOption = $(this).find('option:selected');
            const serviceCode = selectedOption.data('code');

            switch(serviceCode) {
                case 'credit_card':
                    $('#creditCardDetailsContainer').show();
                    break;
                case 'transfer_funds':
                    $('#transferFundsDetailsContainer').show();
                    break;
                case 'mortgage':
                    $('#mortgageDetailsContainer').show();
                    break;
            }
        });

        $('#addServiceBtn').click(function() {
            const serviceId = $('#serviceSelect').val();
            const serviceName = $('#serviceSelect option:selected').text();
            const serviceCode = $('#serviceSelect option:selected').data('code');

            let serviceDetails = {};

            switch(serviceCode) {
                case 'credit_card':
                    serviceDetails = {
                        creditCardDetails: {
                            creditLimit: $('#creditLimit').val(),
                            interestRate: $('#interestRate').val(),
                            loanTerm: $('#loanTerm').val()
                        }
                    };
                    break;
                case 'transfer_funds':
                    serviceDetails = {
                        transferFundsDetails: {
                            transferType: $('#transferType').val(),
                            transferAmount: $('#transferAmount').val(),
                            commission: $('#commission').val()
                        }
                    };
                    break;
                case 'mortgage':
                    serviceDetails = {
                        mortgageDetails: {
                            loanAmount: $('#loanAmount').val(),
                            loanTerm: $('#mortgageLoanTerm').val(),
                            interestRate: $('#mortgageInterestRate').val()
                        }
                    };
                    break;
            }

            const cartItem = {
                serviceId: serviceId,
                serviceName: serviceName,
                ...serviceDetails
            };

            cart.push(cartItem);
            updateCartView();
        });

        function updateCartView() {
            const cartBody = $('#cartBody');
            cartBody.empty();

            cart.forEach((item, index) => {
                const row = `
                    <tr>
                        <td>${item.serviceName}</td>
                        <td>
                            <button type="button" onclick="removeFromCart(${index})">Удалить</button>
                        </td>
                    </tr>
                `;
                cartBody.append(row);
            });
        }

        window.removeFromCart = function(index) {
            cart.splice(index, 1);
            updateCartView();
        };

        $('#saveOrderBtn').click(function() {
            const email = $('#userEmail').val();

            if (!email) {
                alert('Введите email');
                return;
            }

            if (cart.length === 0) {
                alert('Добавьте хотя бы одну услугу');
                return;
            }

            const orderData = {
                userEmail: email,
                items: cart
            };

            $.ajax({
                url: '/orders/save',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(orderData),
                success: function(response) {
                    alert('Заказ сохранен. Номер заказа: ' + response.id);
                    window.location.href = '/orders/confirmation/' + response.id;
                },
                error: function(xhr) {
                    console.error('Ошибка:', xhr);
                    alert('Ошибка сохранения заказа: ' + (xhr.responseText || 'Неизвестная ошибка'));
                }
            });
        });
    });
</script>
</body>
</html>